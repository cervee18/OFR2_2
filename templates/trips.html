{% extends 'base.html' %}

{% block content %}
<section class="trips-page">

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }} {{ message }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}

    <div class="trips-header">
        <div class="calendar">  {# Calendar Container #}
            <div class="calendar-header">
                <form method="GET" action="{{ url_for('trips') }}" class="calendar-navigation" id="calendar-form">
                    <select name="month" id="month-selector">
                        {% for month_num, month_name in months.items() %}
                        <option value="{{ month_num }}" {% if selected_month == month_num|int %}selected{% endif %}>{{ month_name }}</option>
                        {% endfor %}
                    </select>
                    <select name="year" id="year-selector">
                        {% for year_option in years %}
                        <option value="{{ year_option }}" {% if selected_year == year_option|int %}selected{% endif %}>{{ year_option }}</option>
                        {% endfor %}
                    </select>
                    <a href="{{ url_for('trips', selected_trip_id=request.args.get('selected_trip_id')) }}" class="today-button">Today</a>                </form>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                    </tr>
                </thead>
                <tbody>
                    {% set calendar_days = calendar.Calendar().monthdatescalendar(selected_year|int, selected_month|int) %}
                    {% for week in calendar_days %}
                    <tr>
                        {% for day in week %}
                        <td {% if day.strftime('%Y-%m-%d') == selected_date_str %}class="selected-day"{% endif %}
                            {% if day.month != selected_month|int %}class="other-month-day"{% endif %}>
                            <a href="{{ url_for('trips', year=selected_year, month=selected_month, date=day.strftime('%Y-%m-%d'), selected_trip_id=request.args.get('selected_trip_id')) }}">{{ day.day }}</a>                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="{{ url_for('edit_trip') }}" class="add-trip-button">Create New Trip</a>
    </div>

    <section class="daily-trips">
        <h3>Trips for {{ selected_date_str }}</h3>
    
        {% if trips %}
        <div class="trips-tabs">
            <div class="tabs-header">
                {% for trip in trips %}
                <button class="tab-button {% if selected_trip and selected_trip.id == trip.id %}active{% endif %}"
                        onclick="window.location.href='{{ url_for('trips', year=selected_year, month=selected_month, date=selected_date_str, selected_trip_id=trip.id) }}'">
                    <span class="trip-name">{{ trip.name }}</span>
                    <span class="tab-details">{{ trip.trip_class }} - {{ trip.start_time }}</span>
                </button>
                {% endfor %}
            </div>
    
            {% if selected_trip %}
            <div class="tab-content">
                <div class="trip-info-grid">
                    <div class="info-item">
                        <span class="label">Trip:</span>
                        <span class="value">{{ selected_trip.name }} ({{ selected_trip.trip_class }})</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Time:</span>
                        <span class="value">{{ selected_trip.start_time }} - {{ selected_trip.end_time }}</span>
                    </div>
                    <div class="info-item">
                        <span class="value">Max Divers: {{ selected_trip.max_divers }} | Staff: {{ selected_trip.needed_staff }}</span>
                    </div>
                </div>
    
            </div>  
            {% endif %} 
    
            <button class="add-client-button" onclick="openAddClientPopup()"
                {% if not selected_trip %}disabled{% endif %} >  
                Add Client
            </button>
    
            {% if selected_trip %} 
            <div class="client-table-container">
                <table class="client-table table-common">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Certification</th>
                            <th>Last Dive</th>
                            <th>Mask</th>
                            <th>BCD</th>
                            <th>Wetsuit</th>
                            <th>Fins</th>
                            <th>Weights</th>
                            <th>Nitrox Cert</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if clients_on_trip %}
                        {% for client in clients_on_trip %}
                        {% set equipment = client.equipment_assignments|selectattr("trip_id", "eq", selected_trip.id)|first %}
                        <tr data-client-id="{{ client.id }}" data-trip-id="{{ selected_trip.id }}">
                            <td>{{ client.name }} {{ client.surname }}</td>
                            <td>{{ client.certification_level }}</td>
                            <td>{{ client.last_dive_day }}</td>
                            <td>
                                <select name="mask_size" class="equipment-select">
                                    <option value="">-- Select --</option>
                                    <option value="adult" {% if equipment and equipment.mask_size == 'adult' %}selected{% endif %}>Adult</option>
                                    <option value="kid" {% if equipment and equipment.mask_size == 'kid' %}selected{% endif %}>Kid</option>
                                </select>
                            </td>
                            <td>
                                <select name="bcd_size" class="equipment-select">
                                    <option value="">-- Select --</option>
                                    {% for size in ['XXS', 'XS', 'S', 'M', 'L', 'XL', 'XXL'] %}
                                        <option value="{{ size }}" {% if equipment and equipment.bcd_size == size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="wetsuit_size" class="equipment-select">
                                    <option value="">-- Select --</option>
                                    {% for size in ['XXS', 'XS', 'S', 'M', 'L', 'XL', 'XXL'] %}
                                        <option value="{{ size }}" {% if equipment and equipment.wetsuit_size == size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select name="fins_size" class="equipment-select">
                                    <option value="">-- Select --</option>
                                    {% for size in ['XXS', 'XS', 'S', 'M', 'L', 'XL', 'XXL'] %}
                                        <option value="{{ size }}" {% if equipment and equipment.fins_size == size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" name="weights_amount" class="equipment-input" 
                                       value="{{ equipment.weights_amount if equipment and equipment.weights_amount else '' }}">
                            </td>
                            <td>{% if client.nitrox_certification_number %}Yes{% else %}No{% endif %}</td>
                            <td>{{ client.notes }}</td>
                            <td>
                                <button type="button" class="save-equipment-btn" onclick="saveEquipment(this)">Save</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="11">No clients assigned to this trip yet.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <script>
            function saveEquipment(btn) {
                const row = btn.closest('tr');
                const clientId = row.dataset.clientId;
                const tripId = row.dataset.tripId;
                
                const equipmentData = {
                    mask_size: row.querySelector('select[name="mask_size"]').value,
                    bcd_size: row.querySelector('select[name="bcd_size"]').value,
                    wetsuit_size: row.querySelector('select[name="wetsuit_size"]').value,
                    fins_size: row.querySelector('select[name="fins_size"]').value,
                    weights_amount: row.querySelector('input[name="weights_amount"]').value,
                };
            
                // We'll need to create a route for this
                fetch(`/trips/save_equipment/${tripId}/${clientId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(equipmentData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Equipment saved successfully');
                    } else {
                        alert('Error saving equipment');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving equipment');
                });
            }
            </script>
            {% endif %}
    
        </div>
        {% else %}
        <p>No trips scheduled for this date.</p>
        {% endif %} 
    </section>

    <script>
        document.getElementById('month-selector').addEventListener('change', function() {
            document.getElementById('calendar-form').submit();
        });

        document.getElementById('year-selector').addEventListener('change', function() {
            document.getElementById('calendar-form').submit();
        });

        function openAddClientPopup() {
        {% if selected_trip %}
            var tripId = "{{ selected_trip.id }}"; 
            var popupUrl = "{{ url_for('trips_add_clients', trip_id=selected_trip.id) }}"; 
            window.open(popupUrl, "AddClientsPopup", "width=800,height=600,resizable=yes,scrollbars=yes"); 
        {% else %}
            alert("No trip selected. Please select a trip tab first."); // Inform user (optional, as button is disabled)
        {% endif %}
        }
    </script>
</section>
{% endblock %}